<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track and optimize your espresso extractions">
    <meta name="theme-color" content="#6f4e37">
    <title>‚òï ShotBuster</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <link rel="apple-touch-icon" href="icons/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --coffee: #6f4e37;
            --cream: #f5deb3;
            --dark: #3e2723;
            --light: #fff9f0;
            --accent: #d2691e;
            --danger: #d32f2f;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, var(--cream) 0%, var(--light) 100%);
            color: var(--dark);
            line-height: 1.6;
            padding-bottom: 2rem;
        }

        header {
            background: linear-gradient(135deg, var(--coffee) 0%, var(--dark) 100%);
            color: white;
            padding: 2rem 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 0 1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .card h2 {
            color: var(--coffee);
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--dark);
        }

        .form-group input,
        .form-group select {
            padding: 0.75rem;
            border: 2px solid var(--cream);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--coffee);
            box-shadow: 0 0 0 3px rgba(111, 78, 55, 0.1);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .calculated {
            background: var(--cream);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--coffee);
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 150px;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: var(--coffee);
            color: white;
        }

        .btn-primary:hover {
            background: var(--dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .btn-secondary {
            background: var(--accent);
            color: white;
        }

        .btn-secondary:hover {
            background: var(--coffee);
            transform: translateY(-2px);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #b71c1c;
        }

        .shots-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .shot-item {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--coffee);
        }

        .shot-item.troubleshooting {
            border-left-color: var(--danger);
            background: #ffebee;
        }

        .shot-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .shot-coffee {
            font-weight: bold;
            color: var(--coffee);
            font-size: 1.1rem;
        }

        .shot-datetime {
            font-size: 0.9rem;
            color: #666;
        }

        .troubleshooting-badge {
            display: inline-block;
            background: var(--danger);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .shot-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .shot-detail {
            display: flex;
            justify-content: space-between;
        }

        .shot-detail strong {
            color: var(--dark);
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        datalist {
            display: none;
        }

        .info-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.25rem;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.5rem;
            }

            .container {
                margin: 1rem auto;
            }

            .card {
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>‚òï ShotBuster</h1>
        <p>Track and optimize your espresso extractions</p>
    </header>

    <div class="container">
        <!-- New Shot Form -->
        <div class="card">
            <h2>üìù New Shot</h2>
            <form id="shotForm">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="coffee">Coffee</label>
                        <input type="text" id="coffee" name="coffee" list="coffeeList" required placeholder="Coffee name or origin">
                        <datalist id="coffeeList"></datalist>
                    </div>

                    <div class="form-group">
                        <label for="screen">Screen</label>
                        <input type="text" id="screen" name="screen" list="screenList" placeholder="e.g., Standard extract">
                        <datalist id="screenList"></datalist>
                    </div>

                    <div class="form-group">
                        <label for="preinfusion">Preinfusion</label>
                        <select id="preinfusion" name="preinfusion">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="dose">Dose (g)</label>
                        <input type="number" id="dose" name="dose" step="0.1" required placeholder="18.0">
                    </div>

                    <div class="form-group">
                        <label for="grindsize">Grind Size</label>
                        <input type="number" id="grindsize" name="grindsize" min="0" max="18" step="0.25" placeholder="5.0">
                        <span class="info-text">0-18 (0.25 increments)</span>
                    </div>

                    <div class="form-group">
                        <label for="yield">Yield (g)</label>
                        <input type="number" id="yield" name="yield" step="0.1" required placeholder="36.0">
                    </div>

                    <div class="form-group full-width calculated" id="ratioDisplay">
                        Ratio: -
                    </div>

                    <div class="form-group">
                        <label for="time">Time (s)</label>
                        <input type="number" id="time" name="time" step="0.1" required placeholder="28.0">
                    </div>

                    <div class="form-group">
                        <label for="troubleshooting">Troubleshooting</label>
                        <select id="troubleshooting" name="troubleshooting">
                            <option value="No">No</option>
                            <option value="Yes">Yes</option>
                        </select>
                        <span class="info-text">Mark disastrous shots</span>
                    </div>

                    <div class="form-group full-width">
                        <label for="notes">Notes</label>
                        <input type="text" id="notes" name="notes" placeholder="Tasting notes, observations...">
                    </div>
                </div>

                <div class="btn-group">
                    <button type="submit" class="btn-primary">üíæ Save Shot</button>
                    <button type="button" class="btn-secondary" id="clearBtn">üóëÔ∏è Clear</button>
                </div>
            </form>
        </div>

        <!-- Shots History -->
        <div class="card">
            <h2>üìä Shot History</h2>
            <div class="btn-group">
                <button type="button" class="btn-secondary" id="exportBtn">üì• Export CSV</button>
                <button type="button" class="btn-secondary" id="importBtn">üì§ Import CSV</button>
                <button type="button" class="btn-danger" id="clearAllBtn">üóëÔ∏è Clear All</button>
            </div>
            <input type="file" id="importFile" accept=".csv" style="display: none;">
            
            <div id="shotsList" class="shots-list">
                <div class="empty-state">No shots recorded yet</div>
            </div>
        </div>
    </div>

    <script>
        // Application state
        let shots = JSON.parse(localStorage.getItem('shots') || '[]');
        let lastShot = JSON.parse(localStorage.getItem('lastShot') || 'null');

        // DOM elements
        const form = document.getElementById('shotForm');
        const shotsList = document.getElementById('shotsList');
        const ratioDisplay = document.getElementById('ratioDisplay');
        const importFile = document.getElementById('importFile');

        // Initialize
        loadLastShotDefaults();
        updateAutocomplete();
        renderShots();

        // Calculate ratio in real-time
        ['dose', 'yield'].forEach(id => {
            document.getElementById(id).addEventListener('input', calculateRatio);
        });

        function calculateRatio() {
            const dose = parseFloat(document.getElementById('dose').value);
            const yieldVal = parseFloat(document.getElementById('yield').value);
            
            if (dose && yieldVal) {
                const ratio = (yieldVal / dose).toFixed(2);
                ratioDisplay.textContent = `Ratio: 1:${ratio}`;
            } else {
                ratioDisplay.textContent = 'Ratio: -';
            }
        }

        // Load last shot defaults
        function loadLastShotDefaults() {
            if (lastShot) {
                document.getElementById('screen').value = lastShot.screen || '';
                document.getElementById('preinfusion').value = lastShot.preinfusion || 'No';
                document.getElementById('dose').value = lastShot.dose || '';
                document.getElementById('grindsize').value = lastShot.grindsize || '';
            }
        }

        // Update autocomplete
        function updateAutocomplete() {
            const coffees = [...new Set(shots.map(s => s.coffee))];
            const screens = [...new Set(shots.map(s => s.screen).filter(Boolean))];

            document.getElementById('coffeeList').innerHTML = coffees.map(c => `<option value="${c}">`).join('');
            document.getElementById('screenList').innerHTML = screens.map(s => `<option value="${s}">`).join('');
        }

        // Save shot
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const formData = new FormData(form);
            const now = new Date();
            
            const shot = {
                date: now.toISOString().split('T')[0],
                time: now.toTimeString().split(' ')[0].substring(0, 5),
                datetime: now.toISOString(),
                coffee: formData.get('coffee'),
                screen: formData.get('screen') || null,
                preinfusion: formData.get('preinfusion'),
                dose: parseFloat(formData.get('dose')),
                grindsize: formData.get('grindsize') ? parseFloat(formData.get('grindsize')) : null,
                yield: parseFloat(formData.get('yield')),
                time: parseFloat(formData.get('time')),
                troubleshooting: formData.get('troubleshooting'),
                notes: formData.get('notes') || null
            };

            shot.ratio = (shot.yield / shot.dose).toFixed(2);

            shots.unshift(shot);
            localStorage.setItem('shots', JSON.stringify(shots));
            localStorage.setItem('lastShot', JSON.stringify(shot));
            lastShot = shot;

            // Clear form but keep defaults
            form.reset();
            loadLastShotDefaults();
            calculateRatio();
            updateAutocomplete();
            renderShots();

            alert('‚úÖ Shot saved successfully');
        });

        // Clear form
        document.getElementById('clearBtn').addEventListener('click', () => {
            if (confirm('Clear the form?')) {
                form.reset();
                ratioDisplay.textContent = 'Ratio: -';
            }
        });

        // Render shots
        function renderShots() {
            if (shots.length === 0) {
                shotsList.innerHTML = '<div class="empty-state">No shots recorded yet</div>';
                return;
            }

            shotsList.innerHTML = shots.map((shot, index) => {
                const datetime = new Date(shot.datetime);
                const dateStr = datetime.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric'
                });
                const timeStr = datetime.toLocaleTimeString('en-US', {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                });

                const troubleshootingClass = shot.troubleshooting === 'Yes' ? 'troubleshooting' : '';
                const troubleshootingBadge = shot.troubleshooting === 'Yes' ? '<span class="troubleshooting-badge">‚ö†Ô∏è Troubleshooting</span>' : '';

                return `
                    <div class="shot-item ${troubleshootingClass}">
                        <div class="shot-header">
                            <div>
                                <span class="shot-coffee">${shot.coffee}</span>
                                ${troubleshootingBadge}
                            </div>
                            <span class="shot-datetime">${dateStr} ${timeStr}</span>
                        </div>
                        <div class="shot-details">
                            ${shot.screen ? `<div class="shot-detail"><strong>Screen:</strong> <span>${shot.screen}</span></div>` : ''}
                            <div class="shot-detail"><strong>Preinfusion:</strong> <span>${shot.preinfusion}</span></div>
                            <div class="shot-detail"><strong>Dose:</strong> <span>${shot.dose}g</span></div>
                            ${shot.grindsize !== null ? `<div class="shot-detail"><strong>Grind:</strong> <span>${shot.grindsize}</span></div>` : ''}
                            <div class="shot-detail"><strong>Yield:</strong> <span>${shot.yield}g</span></div>
                            <div class="shot-detail"><strong>Ratio:</strong> <span>1:${shot.ratio}</span></div>
                            <div class="shot-detail"><strong>Time:</strong> <span>${shot.time}s</span></div>
                            ${shot.notes ? `<div class="shot-detail" style="grid-column: 1/-1;"><strong>Notes:</strong> <span>${shot.notes}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Export CSV
        document.getElementById('exportBtn').addEventListener('click', () => {
            if (shots.length === 0) {
                alert('No data to export');
                return;
            }

            const headers = ['Date', 'Time', 'Coffee', 'Screen', 'Preinfusion', 'Dose (g)', 'Grind Size', 'Yield (g)', 'Ratio', 'Time (s)', 'Troubleshooting', 'Notes'];
            const rows = shots.map(s => [
                s.date,
                s.time,
                s.coffee,
                s.screen || '',
                s.preinfusion,
                s.dose,
                s.grindsize !== null ? s.grindsize : '',
                s.yield,
                s.ratio,
                s.time,
                s.troubleshooting,
                s.notes || ''
            ]);

            const csv = [headers, ...rows]
                .map(row => row.map(cell => `"${cell}"`).join(','))
                .join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `shotbuster_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });

        // Import CSV
        document.getElementById('importBtn').addEventListener('click', () => {
            importFile.click();
        });

        importFile.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const csv = event.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                    
                    const importedShots = lines.slice(1).map(line => {
                        const values = line.split(',').map(v => v.replace(/"/g, '').trim());
                        
                        const dateTime = new Date(`${values[0]} ${values[1]}`);
                        
                        return {
                            date: values[0],
                            time: values[1],
                            datetime: dateTime.toISOString(),
                            coffee: values[2],
                            screen: values[3] || null,
                            preinfusion: values[4],
                            dose: parseFloat(values[5]),
                            grindsize: values[6] ? parseFloat(values[6]) : null,
                            yield: parseFloat(values[7]),
                            ratio: values[8],
                            time: parseFloat(values[9]),
                            troubleshooting: values[10],
                            notes: values[11] || null
                        };
                    });

                    shots = [...importedShots, ...shots];
                    localStorage.setItem('shots', JSON.stringify(shots));
                    updateAutocomplete();
                    renderShots();
                    alert(`‚úÖ ${importedShots.length} shots imported successfully`);
                } catch (error) {
                    alert('‚ùå Error importing CSV file');
                    console.error(error);
                }
            };
            reader.readAsText(file);
            importFile.value = '';
        });

        // Clear all
        document.getElementById('clearAllBtn').addEventListener('click', () => {
            if (confirm('‚ö†Ô∏è Are you sure you want to delete ALL data? This cannot be undone.')) {
                if (confirm('‚ö†Ô∏è FINAL CONFIRMATION: All recorded shots will be deleted.')) {
                    shots = [];
                    localStorage.removeItem('shots');
                    localStorage.removeItem('lastShot');
                    lastShot = null;
                    renderShots();
                    updateAutocomplete();
                    alert('‚úÖ All data has been deleted');
                }
            }
        });
    </script>

    <script>
        // Service Worker registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('SW registration error:', err));
            });
        }
    </script>
</body>
</html>
